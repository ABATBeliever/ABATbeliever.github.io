<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEF形式圧縮オフラインコンバータ(β)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            border: none;
            color: #fff;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        input[type="password"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AEF形式圧縮オフラインコンバータ(β) v0.16</h1>
        <p>独自の形式に圧縮します。ベータ版です。</p>
        
        <h2>ファイルアップロード</h2>
        <input type="file" id="fileInput">
        <input type="password" id="passwordInput" placeholder="パスワードを入力...">
        <button id="encryptBtn" onclick="encryptFile()">暗号化する</button>
        <button id="decryptBtn" onclick="decryptFile()">復号化する</button>
        
        <h2>ログ</h2>
        <textarea id="log" readonly></textarea>
    </div>
    
    <script>
        let fileData;
        let encryptedData;
        let encryptionKey;
        let iv;
        let salt;
        let originalFileName;
        let originalFileNameWithoutExt;
        let isAefFile = false;

        document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
        document.getElementById('passwordInput').addEventListener('input', handlePasswordChange, false);

        function log(message) {
            const logArea = document.getElementById('log');
            logArea.value += message + '\n';
        }

        function toggleButtons(disable) {
            document.getElementById('encryptBtn').disabled = disable;
            document.getElementById('decryptBtn').disabled = disable;
            document.getElementById('fileInput').disabled = disable;
            document.getElementById('passwordInput').disabled = disable;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            originalFileName = file.name;
            originalFileNameWithoutExt = originalFileName.substring(0, originalFileName.lastIndexOf('.'));
            const reader = new FileReader();
            
            reader.onloadstart = () => {
                toggleButtons(true);
                log('読込を開始します,,,');
            };
            
            reader.onload = function(event) {
                fileData = event.target.result;
                if (originalFileName.endsWith('.aef')) {
                    isAefFile = true;
                    encryptedData = new Uint8Array(fileData); // Initialize encryptedData for decryption
                    log('AEFバイナリです。復号化出来ます。');
                } else {
                    isAefFile = false;
                    log('ファイルを読み込みました。暗号化出来ます。');
                }
            };
            
            reader.onloadend = () => {
                toggleButtons(false);
            };
            
            reader.readAsArrayBuffer(file);
        }

        function handlePasswordChange() {
            // Password change logic can be used if needed.
        }

        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const passwordBytes = encoder.encode(password);
            const keyMaterial = await crypto.subtle.importKey('raw', passwordBytes, 'PBKDF2', false, ['deriveKey']);
            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 128 },
                true,
                ['encrypt', 'decrypt']
            );
            return key;
        }

        async function encryptFile() {
            if (!fileData || isAefFile) {
                log('ファイルをアップロードしてください。');
                return;
            }

            const password = document.getElementById('passwordInput').value;
            if (!password) {
                log('パスワードを入力してください。');
                return;
            }

            toggleButtons(true);
            log('AEF暗号化を開始,,,');

            try {
                salt = crypto.getRandomValues(new Uint8Array(16));
                const key = await deriveKey(password, salt);
                iv = crypto.getRandomValues(new Uint8Array(12));
                const alg = { name: 'AES-GCM', iv: iv };

                const encrypted = await crypto.subtle.encrypt(alg, key, fileData);

                const encoder = new TextEncoder();
                const fileNameBytes = encoder.encode(originalFileName);
                const fileNameLength = fileNameBytes.length;
                const fileNameLengthBytes = new Uint8Array([fileNameLength]);

                encryptedData = new Uint8Array(1 + fileNameLength + 16 + iv.length + encrypted.byteLength);
                encryptedData.set(fileNameLengthBytes, 0);
                encryptedData.set(fileNameBytes, 1);
                encryptedData.set(salt, 1 + fileNameLength);
                encryptedData.set(iv, 1 + fileNameLength + 16);
                encryptedData.set(new Uint8Array(encrypted), 1 + fileNameLength + 16 + iv.length);

                log('暗号化完了。出力します。');
                saveAsBinaryFile(encryptedData.buffer, `${originalFileNameWithoutExt}.aef`);
            } catch (error) {
                log('暗号化に失敗しました: ' + error.message);
            } finally {
                toggleButtons(false);
            }
        }

        async function decryptFile() {
            if (!encryptedData || !isAefFile) {
                log('まずAEF形式のファイルをアップロードしてください。');
                return;
            }

            const password = document.getElementById('passwordInput').value;
            if (!password) {
                log('パスワードを入力してください。');
                return;
            }

            toggleButtons(true);
            log('復号化を開始,,,');

            try {
                const fileNameLength = encryptedData[0];
                const fileNameBytes = encryptedData.slice(1, 1 + fileNameLength);
                salt = encryptedData.slice(1 + fileNameLength, 1 + fileNameLength + 16);
                iv = encryptedData.slice(1 + fileNameLength + 16, 1 + fileNameLength + 16 + 12);
                const ciphertext = encryptedData.slice(1 + fileNameLength + 16 + 12);

                const decoder = new TextDecoder();
                const originalFileName = decoder.decode(fileNameBytes);
                const alg = { name: 'AES-GCM', iv: iv };

                const key = await deriveKey(password, salt);
                const decryptedData = await crypto.subtle.decrypt(alg, key, ciphertext);

                log(`復号化完了: ${originalFileName}。 出力します。`);
                saveAsBinaryFile(decryptedData, originalFileName);
            } catch (error) {
                log('復号化に失敗しました: ' + error.message);
            } finally {
                toggleButtons(false);
            }
        }

        function saveAsBinaryFile(data, filename) {
            const blob = new Blob([data], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
