<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindowsPEイメージの作り方</title>
</head>
<body>
    <header>
        <h1>WindowsPEイメージの作り方</h1>
        <nav>
            <ul>
		<p>2023/09/17時点</p>
            </ul>
        </nav>
    </header>

    <main>
        <section>
            <h1>参考にしたサイト</h1>
            <a href="https://qiita.com/SkyLaptor/items/204245cf6bb4fee5b19d">https://qiita.com/SkyLaptor/items/204245cf6bb4fee5b19d<br></a>
            <a href="https://qiita.com/bibouroku/items/d0836b7d927d21be047c">https://qiita.com/bibouroku/items/d0836b7d927d21be047c<br></a>
            <a href="https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install">https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install<br></a>
            <a href="https://qiita.com/kwhrkzk/items/543284b357108c5906b2">https://qiita.com/kwhrkzk/items/543284b357108c5906b2<br></a>
            <a href="https://learn.microsoft.com/ja-jp/mem/configmgr/osd/get-started/manage-boot-images">https://learn.microsoft.com/ja-jp/mem/configmgr/osd/get-started/manage-boot-images<br></a>
            <a href="https://learn.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-intro?view=windows-11">https://learn.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-intro?view=windows-11<br></a>
        </section>

        <section>
            <h1>使うファイル</h1>
            <p>・WindowsADK(11と書いているが10の22H2でも動いた)</p>
            <a href="https://go.microsoft.com/fwlink/?linkid=2196127">https://go.microsoft.com/fwlink/?linkid=2196127<br></a>
            <p>・WindowsADK PEアドオン</p>
            <a href="https://go.microsoft.com/fwlink/?linkid=2196224">https://go.microsoft.com/fwlink/?linkid=2196224<br></a>
            <p>・WindowsADK loTCoreアドイン(予備)</p>
            <a href="https://github.com/ms-iot/iot-adk-addonkit/">https://github.com/ms-iot/iot-adk-addonkit/<br></a>
            <p>・WindowsADK 過去バージョン</p>
            <a href="https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install#other-adk-downloads">https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install#other-adk-downloads<br></a>
        </section>

        <section>
            <h1>環境準備</h1>
            <h3>※Virtualboxなど推奨</h3>
            <h3>0:仮想環境(任意)</h3>
            <p>・Virtualboxをダウンロード・セットアップ</p>
            <p>・Windows10/11をセットアップ</p>
            <h3>1:WindowsADKをインストール</h3>
            <p>・「場所の指定」では上下どちらでもよい</p>
            <p>・「インストールを行う機能を選択してください」では「Deployment Tools」があればそれ以外はどちらでもいい</p>
            <h3>2:WindowsADK PEアドオンをインストール</h3>
            <p>・「場所の指定」では上下どちらでもよい</p>
            <p>・「Select the features you want to install」ではすべて選択</p>
        </section>

        <section>
            <h1>イメージ作成</h1>
            <h3>1:「展開およびｲﾒｰｼﾞﾝｸﾞﾂｰﾙ環境」を「管理者で」起動</h3>
            <h3>2:作業パスを指定(どこでもいい)</h3>
            <p>set WS_DIR=C:\winpe</p>
            <p>set ADK_PATH=C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit</p>
            <p>set ADK_PACK=%ADK_PATH%\Windows Preinstallation Environment\amd64\WinPE_OCs</p>
            <h3>3:WindowsPEイメージの準備</h3>
            <p>copype amd64 "%WS_DIR%"</p>
            <p>Dism /Mount-Image /Imagefile:"%WS_DIR%\media\sources\boot.wim" /Index:1 /Mountdir:"%WS_DIR%\mount"</p>
            <h3>4:日本語化など1/2</h3>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\lp.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-FontSupport-JA-JP.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-WMI.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\WinPE-WMI_ja-jp.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-NetFx.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\WinPE-NetFx_ja-jp.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-Scripting.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\WinPE-Scripting_ja-jp.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-PowerShell.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\WinPE-PowerShell_ja-jp.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-DismCmdlets.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\WinPE-DismCmdlets_ja-jp.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-SecureBootCmdlets.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\WinPE-WDS-Tools.cab"</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Package /Packagepath:"%ADK_PACK%\ja-jp\WinPE-WDS-Tools_ja-jp.cab"</p>
            <h3>5:機能有効化(エラーが起こった場合無視)</h3>
            <p>Dism /Image:"%WS_DIR%\mount" /Enable-Feature /FeatureName:SMB1Protocol</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Enable-Feature /FeatureName:TelnetClient</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Enable-Feature /FeatureName:TFTP</p>
            <h3>6:日本語化など2/2</h3>
            <p>Dism /Image:"%WS_DIR%\mount" /Set-Allintl:ja-jp</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Set-Inputlocale:0411:{03B5835F-F03C-411B-9CE2-AA23E1171E36}{A76C93D9-5523-4E90-AAFA-4DB112F9AC76}</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Set-Layereddriver:6</p>
            <p>Dism /Image:"%WS_DIR%\mount" /Set-Timezone:"Tokyo Standard Time"</p>
            <h3>7:ドライバ(入れる場合)</h3>
            <p>Dism /Image:"%WS_DIR%\mount" /Add-Driver /Driver:{ドライバファイル(.inf)} /ForceUnsigned</p>
            <h3>8:各種ファイルインストール</h3>
            <p>"C:\winpe\mount\Program Files"か"C:\winpe\mount\Windows\System32"に入れる</p>
            <p>CPU-ZやCrystalDiskinfoなどは動きました</p>
            <p>Firefox,Chromeなどはポータブルでも動きません</p>
            <h3>9:起動時の見た目</h3>
            <p>"C:\winpe\mount\Windows\System32\Startnet.cmd"を編集する</p>
            <p>(※タスクマネージャー経由で、管理者でメモ帳を起動しないと保存できない)</p>
            <p>・「wpeinit」は一番上に</p>
            <p>・このファイルが閉じられると再起動になる</p>
            <p><<コマンド例>></p>
            <p>・"wpeutil shutdown" - シャットダウン</p>
            <p>・"exit" - 再起動</p>
            <p>・"powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c" - 電源を高パフォーマンスに</p>
            <p>・"diskpart /s x:\CreatePartitions-UEFI.txt" - パーティションを「C:\winpe\mount\CreatePartitions-UEFI.txtに沿って作成」</p>
            <p>=================================================</p>
            <p>「CreatePartitions-UEFI.txt」の例</p>
            <p>select disk 0</p>
            <p>clean</p>
            <p>convert gpt</p>
            <p>create partition efi size=100</p>
            <p>format quick fs=fat32 label="System"</p>
            <p>create partition msr size=16</p>
            <p>create partition primary size=143139</p>
            <p>format quick fs=ntfs </p>
            <p>assign letter=d</p>
            <p>create partition primary</p> 
            <p>shrink minimum=1024</p>
            <p>format quick fs=ntfs label="Windows"</p>
            <p>assign letter=c</p>
            <p>create partition primary</p>
            <p>format quick fs=ntfs label="Recovery tools"</p>
            <p>set id="de94bba4-06d1-4d40-a16a-bfd50179d6ac"</p>
            <p>gpt attributes=0x8000000000000001</p>
            <p>list volume</p>
            <p>=================================================</p>
            <p>・"dism /Apply-Image /ImageFile:e:\install.wim /Index:1 /ApplyDir:c:\" - wimの設定でWindowsをインストール</p>
            <p>・"bcdboot C:\Windows /l ja-jp" - 次回から起動</p>
            <h3>10:変更適応とビルド</h3>
            <p>Dism /Unmount-Image /Mountdir:"%WS_DIR%\mount" /Commit</p>
            <p>makewinpemedia /iso "%WS_DIR%" C:\winpe.iso</p>
            <p>※isoイメージはC:\winpeもしくはCドライブ直下にできます</p>
            <h3>11:お片付け</h3>
            <p>Dism /Cleanup-Wim</p>
            <p>rd /s /q c:\winpe\</p>
        </section>

        <section>
            <h1>参考にしたサイト</h1>
            <a href="https://qiita.com/SkyLaptor/items/204245cf6bb4fee5b19d">https://qiita.com/SkyLaptor/items/204245cf6bb4fee5b19d<br></a>
            <a href="https://qiita.com/bibouroku/items/d0836b7d927d21be047c">https://qiita.com/bibouroku/items/d0836b7d927d21be047c<br></a>
            <a href="https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install">https://learn.microsoft.com/ja-jp/windows-hardware/get-started/adk-install<br></a>
            <a href="https://qiita.com/kwhrkzk/items/543284b357108c5906b2">https://qiita.com/kwhrkzk/items/543284b357108c5906b2<br></a>
            <a href="https://learn.microsoft.com/ja-jp/mem/configmgr/osd/get-started/manage-boot-images">https://learn.microsoft.com/ja-jp/mem/configmgr/osd/get-started/manage-boot-images<br></a>
            <a href="https://learn.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-intro?view=windows-11">https://learn.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/winpe-intro?view=windows-11<br></a>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 ABATBeliever</p>
    </footer>
</body>
</html>
