<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPG形式圧縮 オフラインコンバータ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            border: none;
            color: #fff;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        input[type="password"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EPG形式圧縮 オフラインコンバータ v1.00</h1>
        <p>AES-256で暗号化されたPNG形式に圧縮します。<br>ファイル名は解凍時に復元されます。<br>HMAC認証も含まれます。<br>すべての処理はJavaScriptで行われ、オフラインで行えます。(htmlをダウンロードする必要あり。)<br>バージョン間の互換性は保証されません。</p>
        
        <h2>ファイルアップロード</h2>
        <input type="file" id="fileInput">
        <input type="password" id="passwordInput" placeholder="パスワードを入力...">
        <button id="encryptBtn" onclick="encryptFile()">暗号化する</button>
        <button id="decryptBtn" onclick="decryptFile()">復号化する</button>
        
        <h2>ログ</h2>
        <textarea id="log" readonly></textarea>
    </div>
    
    <script>
        let fileData;
        let encryptedData;
        let encryptionKey;
        let iv;
        let salt;
        let originalFileName;
        let originalFileNameWithoutExt;
        let isEPGFile = false;

        document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
        document.getElementById('passwordInput').addEventListener('input', handlePasswordChange, false);

        function log(message) {
            const logArea = document.getElementById('log');
            logArea.value += message + '\n';
        }

        function toggleButtons(disable) {
            document.getElementById('encryptBtn').disabled = disable;
            document.getElementById('decryptBtn').disabled = disable;
            document.getElementById('fileInput').disabled = disable;
            document.getElementById('passwordInput').disabled = disable;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            originalFileName = file.name;
            originalFileNameWithoutExt = originalFileName.substring(0, originalFileName.lastIndexOf('.'));
            const reader = new FileReader();
            
            reader.onloadstart = () => {
                toggleButtons(true);
                log('読込を開始します,,,');
            };
            
            reader.onload = function(event) {
                fileData = event.target.result;
                if (originalFileName.endsWith('.epg')) {
                    isEPGFile = true;
                    encryptedData = new Uint8Array(fileData); // Initialize encryptedData for decryption
                    log('EPGバイナリです。復号化出来ます。');
                } else {
                    isEPGFile = false;
                    log('ファイルを読み込みました。暗号化出来ます。');
                }
            };
            
            reader.onloadend = () => {
                toggleButtons(false);
            };
            
            reader.readAsArrayBuffer(file);
        }

        function handlePasswordChange() {
            // Password change logic can be used if needed.
        }

        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const passwordBytes = encoder.encode(password);
            const keyMaterial = await crypto.subtle.importKey('raw', passwordBytes, 'PBKDF2', false, ['deriveKey']);
            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
            return key;
        }

        async function generateHMAC(key, data) {
            const hmacKey = await crypto.subtle.importKey(
                'raw',
                key,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            const hmac = await crypto.subtle.sign('HMAC', hmacKey, data);
            return new Uint8Array(hmac);
        }

        async function encryptFile() {
            if (!fileData || isEPGFile) {
                log('ファイルをアップロードしてください。');
                return;
            }

            const password = document.getElementById('passwordInput').value;
            if (!password) {
                log('パスワードを入力してください。');
                return;
            }

            toggleButtons(true);
            log('EPG暗号化を開始,,,');
            
            try {
                salt = crypto.getRandomValues(new Uint8Array(16));
                const key = await deriveKey(password, salt);
                iv = crypto.getRandomValues(new Uint8Array(12));
                const alg = { name: 'AES-GCM', iv: iv };

                const encrypted = await crypto.subtle.encrypt(alg, key, fileData);

                const encoder = new TextEncoder();
                const fileNameBytes = encoder.encode(originalFileName);
                const encryptedFileName = await crypto.subtle.encrypt(alg, key, fileNameBytes);
                const fileNameLength = encryptedFileName.byteLength;
                const fileNameLengthBytes = new Uint8Array([fileNameLength]);

                const hmacKey = await crypto.subtle.exportKey('raw', key); // HMAC用のキーをエクスポート
                const hmac = await generateHMAC(hmacKey, encrypted);

                encryptedData = new Uint8Array(1 + fileNameLength + 16 + iv.length + encrypted.byteLength + hmac.length);
                encryptedData.set(fileNameLengthBytes, 0);
                encryptedData.set(new Uint8Array(encryptedFileName), 1);
                encryptedData.set(salt, 1 + fileNameLength);
                encryptedData.set(iv, 1 + fileNameLength + 16);
                encryptedData.set(new Uint8Array(encrypted), 1 + fileNameLength + 16 + iv.length);
                encryptedData.set(hmac, 1 + fileNameLength + 16 + iv.length + encrypted.byteLength);

                log('暗号化完了。出力します。');
                saveAsBinaryFile(encryptedData.buffer, `${originalFileNameWithoutExt}.epg`);
            } catch (error) {
                log('暗号化に失敗しました: ' + error.message);
            } finally {
                toggleButtons(false);
            }
        }

        async function verifyHMAC(key, data, hmac) {
            const hmacKey = await crypto.subtle.importKey(
                'raw',
                key,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['verify']
            );
            return await crypto.subtle.verify('HMAC', hmacKey, hmac, data);
        }

        async function decryptFile() {
            if (!encryptedData || !isEPGFile) {
                log('まずEPG形式のファイルをアップロードしてください。');
                return;
            }

            const password = document.getElementById('passwordInput').value;
            if (!password) {
                log('パスワードを入力してください。');
                return;
            }

            toggleButtons(true);
            log('復号化を開始,,,');
            
            try {
                const fileNameLength = encryptedData[0];
                const encryptedFileName = encryptedData.slice(1, 1 + fileNameLength);
                salt = encryptedData.slice(1 + fileNameLength, 1 + fileNameLength + 16);
                iv = encryptedData.slice(1 + fileNameLength + 16, 1 + fileNameLength + 16 + 12);
                const ciphertext = encryptedData.slice(1 + fileNameLength + 16 + 12, encryptedData.length - 32);
                const receivedHmac = encryptedData.slice(encryptedData.length - 32);

                const alg = { name: 'AES-GCM', iv: iv };

                const key = await deriveKey(password, salt);

                const hmacKey = await crypto.subtle.exportKey('raw', key); // HMAC用のキーをエクスポート
                const validHmac = await verifyHMAC(hmacKey, ciphertext, receivedHmac);
                if (!validHmac) {
                    throw new Error('HMAC verification failed');
                }

                const decryptedFileNameBytes = await crypto.subtle.decrypt(alg, key, encryptedFileName);
                const decoder = new TextDecoder();
                const originalFileName = decoder.decode(decryptedFileNameBytes);
                const decryptedData = await crypto.subtle.decrypt(alg, key, ciphertext);

                log(`復号化完了: ${originalFileName}。 出力します。`);
                saveAsBinaryFile(decryptedData, originalFileName);
            } catch (error) {
                log('復号化に失敗しました: ' + error.message);
            } finally {
                toggleButtons(false);
            }
        }

        function saveAsBinaryFile(data, filename) {
            const blob = new Blob([data], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
